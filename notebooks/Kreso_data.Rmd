---
title: "Giotto_Kreso_heart_data"
author: "Chiara Schiller"
date: "2023-03-22"
output: html_document
---
This script takes one sample from Kreso's heart data. I only explores shortly if the results show something interesting. 

###Script

Load packages and initial python setting for Giotto
```{r setup, include=FALSE}

library(Giotto)
library(reticulate)
library(readr)
library(tidyverse)
library(ggplot2)
library(pheatmap)

# Giotto and python configurations
# Create Giotto path
my_instructions = createGiottoInstructions(python_path = '/Users/chiaraschiller/Library/r-miniconda-arm64/bin/python3')
Sys.setenv(RETICULATE_PYTHON = "/Users/chiaraschiller/Library/r-miniconda-arm64/bin/python3")
```

Load data
```{r setup, include=FALSE}

files = list.files("./../../../../Kreso_data/", pattern = ".csv")
data_path = "./../../../../Kreso_data/"
data_list = list()

# rename data to standards used in giotto function
for (i in files){
data_list[[i]] <- readr::read_csv(paste0(data_path,i))
data_list[[i]] <- data_list[[i]] %>% rename("x" = X_centroid, "y"= Y_centroid, "ct" = phenotype) %>% select(x,y,ct)
}

data_list[[1]] 
```

Run Giotto

```{r setup, include=FALSE}

giotto_list = list()
x=0
# create dataframe with random values to pretend to have expression data to generate a giotto object
for (i in data_list){
  x = x+1
  df = data.frame(cbind(rep(1,nrow(i)), rep(1,nrow(i))))
  df$cell_ID = seq(1, nrow(df), by = 1)
  colnames(df) = c("M1", "M2", "cell_ID")

  metadata = cbind(as.character(i$ct), seq(1, nrow(df), by = 1))
  colnames(metadata) = c("ct", "cell_ID")

  data = createGiottoObject(raw_exprs = as.data.frame(t(df)),
                          spatial_locs = as.data.frame(i[, !(names(i) %in% c("ct"))]),
                          #instructions = my_instructions,
                          cell_metadata = metadata)

  data <- normalizeGiotto(gobject = data)
  # create network (required for binSpect methods)
  giotto_list[[files[x]]] = createSpatialNetwork(gobject = data, minimum_k = 2)
}

# calculate cell proximities
# PI value is the proximity index of the feature in the cluster
cell_PI=list()
x=0

for (i in giotto_list){
  x=x+1
  cell_proximities = cellProximityEnrichment(gobject = i,
                        cluster_column = 'ct',
                        spatial_network_name = 'Delaunay_network',
                        adjust_method = 'fdr',
                        number_of_simulations = 1000)

  cell_PI[[files[x]]] = separate(cell_proximities[[2]], unified_int, into = c("label1", "label2"), sep = "--")
  
  # write results
  write.csv(cell_PI[[files[x]]],file=paste0("./../../output/",gsub("\\..*", "", files[x]) ,"_proximities.csv"),row.names = TRUE)
}



```

Explore results

```{r}
data = cell_PI[[1]]
data = data %>% select(label1, label2, PI_value)

# look at heatmap
data = spread(data, key = label1, value = PI_value)
rownames(data) = data$label2
pheatmap(data[,-1], treeheight_row = 0, treeheight_col = 0, cluster_rows = FALSE, cluster_cols = FALSE)

```

